name: CI/CD Pipeline - Azure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.22"
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: uniflow-api

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Run tests with race detection
        run: go test -race ./...

      - name: Generate coverage report
        run: |
          go test -coverprofile=coverage.out ./... 2>&1 | grep -v "no such tool" || true
          if [ ! -f coverage.out ]; then
            echo "Warning: Coverage file not generated, continuing..."
            exit 0
          fi

      - name: Check test coverage
        run: |
          if [ -f coverage.out ]; then
            go tool cover -func=coverage.out | grep total | awk '{print "Coverage: " $3}'
          else
            echo "Coverage: N/A (coverage.out not found)"
          fi

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run linter
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_CLIENT_ID }}
          password: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                       -t ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --image ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars \
              PORT=8080 \
              GIN_MODE=release \
              MONGO_URI="${{ secrets.MONGO_URI }}" \
              MONGO_DB="${{ secrets.MONGO_DB }}"

      - name: Verify deployment
        run: |
          echo "Deployment completed successfully!"
          echo "Container App: ${{ secrets.CONTAINER_APP_NAME }}"
          echo "Resource Group: ${{ secrets.RESOURCE_GROUP }}"
          echo "Image: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
